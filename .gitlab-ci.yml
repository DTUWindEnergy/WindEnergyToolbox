image: dtuwindenergy/wetb



test:
  image: continuumio/anaconda3:latest
  stage:
    test
#  except:
#    - test_pypi
  before_script:
  - git submodule sync --recursive
  - git submodule update --init --recursive
  - pip3 install --find-links=./dist wetb
  - pip3 install pytest mock click
  script:
  - python3 -m pytest --cov-report term-missing:skip-covered --cov-report xml:coverage.xml --cov=wetb
  tags:
  - docker, linux, shared
  coverage: /(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml



# ===== build documentation =====
pages:  # "pages" is a job specifically for GitLab pages [1]
  stage:  # build, test, deploy defined by default [2]
    deploy
  script:  # use sphinx to build docs, move to public page
  - apt-get update
  - pip install --upgrade pip
  - pip install sphinx --upgrade
  - pip install nbsphinx==0.3.5
  - pip install git+https://github.com/vidartf/nbsphinx-link.git
  - cd docs; make html
  - cd ../; mv docs/build/html public/
  artifacts:  # required for GitLab pages [1]
    paths:
    - public
  only:  # only run for these branches
  - master
  - /^test_doc.*/
  tags:  # only runners with this tag can do the job [3]
  - python

# Deploy package to local repository

upload_package_local:
  image: continuumio/anaconda3:latest
  tags:
    - docker, linux, shared
  stage: deploy
  needs:
  - job: build_poetry_wheel
    artifacts: true
  - job: test
    artifacts: false

  script:
    - pip install twine
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --verbose --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*



  # ===== BUILD WHEELS AND UPLOAD TO PYPI =====
pypi_linux:
  stage:
    deploy
  only:
    - tags
    - test_pypi
  script:
    - apt-get update
    - pip install -e . --upgrade
    - python3 -m pip install -U setuptools wheel
    - python3 setup.py sdist bdist_wheel
    - python3 -m pip install -U twine
    - python3 -c 'from git_utils import rename_dist_file; rename_dist_file()'
    - twine upload dist/* -u $TWINE_USERNAME -p $TWINE_PASSWORD
    #- twine upload --repository-url https://test.pypi.org/legacy/ dist/* -u $TWINE_USERNAME -p $TWINE_PASSWORD # for testing purposes
  tags:
    - python


pypi_windows:
  stage:
    deploy
  only:
    - tags
    - test_pypi
  script:
    - c:/Anaconda3/envs/WindEnergyToolbox/python.exe setup.py bdist_wheel
    - twine upload dist/* -u %TWINE_USERNAME% -p %TWINE_PASSWORD%
    #- twine upload --repository-url https://test.pypi.org/legacy/ dist/* -u %TWINE_USERNAME% -p %TWINE_PASSWORD% # for testing purposes
  tags:
    - CPAV_old

build_poetry_wheel:
  stage: build
  tags:
    - linux, docker, shared
  image: registry.windenergy.dtu.dk/hawc2/hawc2-binary/dockerimages/ubuntu_conda

  script:
    - pip install jinja2 gitpython
    - python ./update_pyproject.py
    - poetry build
  
  artifacts:
    paths:
      - dist/*
    expire_in: "1d"
