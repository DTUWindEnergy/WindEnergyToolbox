image: dtuwindenergy/wetb

test-3.4:
  stage:  
    test
#  except:
#    - test_pypi
  script:
  - apt-get update
  - pip3 install pytest
  - pip3 install mock
  - python3 -m pytest --cov=wetb
  tags:
  - python

  # ===== BUILD WHEELS AND UPLOAD TO PYPI =====
pypi_linux:
  stage:  
    deploy
  only:
    - tags
    - test_pypi
  script:
    - apt-get update
    - pip install -e . --upgrade
    - python3 -c 'from git_utils import write_vers; write_vers()'
    - python3 -m pip install -U setuptools wheel
    - python3 setup.py sdist bdist_wheel
    - python3 -m pip install -U twine
    - python3 -c 'from git_utils import rename_dist_file; rename_dist_file()'
    - twine upload dist/* -u $TWINE_USERNAME -p $TWINE_PASSWORD
    #- twine upload --repository-url https://test.pypi.org/legacy/ dist/* -u $TWINE_USERNAME -p $TWINE_PASSWORD # for testing purposes
  tags:  
    - python


pypi_windows:
  stage:  
    deploy
  only:
    - tags
    - test_pypi
  script:
    - c:/Anaconda3/envs/WindEnergyToolbox/python.exe -c "from git_utils import write_vers; write_vers()"
    - c:/Anaconda3/envs/WindEnergyToolbox/python.exe setup.py bdist_wheel
    - twine upload dist/* -u %TWINE_USERNAME% -p %TWINE_PASSWORD%
    #- twine upload --repository-url https://test.pypi.org/legacy/ dist/* -u %TWINE_USERNAME% -p %TWINE_PASSWORD% # for testing purposes
  tags:  
    - CPAV_old

